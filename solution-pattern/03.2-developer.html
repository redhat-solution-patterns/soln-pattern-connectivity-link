<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Solution Pattern: App Connectivity with Policy-as-Code :: Solution Patterns from Red Hat</title>
    <link rel="canonical" href="https://solution.io/solution-pattern/03.2-developer.html">
    <link rel="prev" href="03.1-platform.html">
    <link rel="next" href="developer-resources.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
<link rel="icon" href="../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-TKK0SMEFQH"></script>
<script>function gtag() { dataLayer.push(arguments) }; window.dataLayer = window.dataLayer || []; gtag('js', new Date()); gtag('config', 'G-TKK0SMEFQH')</script>
  </head>
  <body class="article">

<header class="header">
  <script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function () { 
      const urlParams = new URLSearchParams(window.location.search);
      const managedzone = urlParams.get('MANAGEDZONE');
      const subdomain = urlParams.get('SUBDOMAIN'); 
      if (managedzone) {
        showManagedZone( managedzone, subdomain);
      }
      else {
        showManagedZoneForm(subdomain);
      }
    } );


    function showManagedZone( managedzone, subdomain) {
      document.getElementById('navbar-form-empty').style.display = "none";
      document.getElementById('navbar-form-filled').style.display = "flex";
      document.getElementById('managedZoneDisplay').textContent = "Managed Zone : " + managedzone;
      document.getElementById('subdomainDisplay').textContent = "Subdomain : " + subdomain; 
    }

    function showManagedZoneForm( subdomain ) {
      document.getElementById('navbar-form-empty').style.display = "flex";
      document.getElementById('navbar-form-filled').style.display = "none";
      document.getElementById('subdomain').value = subdomain; 

    }

    function goWithManagedZone() {
      elManagedZoneInput = document.getElementById('managedzone');
      elSubdomainInput = document.getElementById('subdomain');
      window.location.search = ('&MANAGEDZONE=' + elManagedZoneInput.value  + '&SUBDOMAIN=' + elSubdomainInput.value);
    }

    function recycle() {
      document.getElementById('managedzone').value='';
      document.getElementById('subdomain').value='';
      window.location.search = ('');
    }


  </script>
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" style="font-size: 20px; color: white" href="https://solution.io">
        <img src="../_/img/logo.png" height="35px" alt="Solution Patterns">&nbsp; Solution Patterns from Red Hat</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Architectures &amp; Patterns</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://www.redhat.com/architect/portfolio/" target="_blank">Portfolio Architecture&nbsp; </a>
            <a class="navbar-item" href="https://redhat-solution-patterns.github.io/solution-patterns/patterns.html"  target="_blank">Solution Patterns </a>
            <a class="navbar-item" href="https://validatedpatterns.io/" target="_blank">Validated Patterns&nbsp;</a>
            <a class="navbar-item" href="https://catalog.redhat.com/solutions" target="_blank">Ecosystem Solutions&nbsp;</a>
          </div>
        </div>

        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Resources</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" target="_blank" href="https://developers.redhat.com">Red Hat Developers</a>
            <a class="navbar-item" target="_blank" href="https://developers.redhat.com/app-dev-platform">App Dev Platform</a>
            <a class="navbar-item" target="_blank" href="https://www.redhat.com/en/products/application-foundations">Red Hat Application Services</a>
          </div>
        </div>

          <a class="navbar-item" target="_blank" href="https://github.com/redhat-solution-patterns/redhat-solution-patterns.github.io/issues">Feedback</a>
          <a class="navbar-item" target="_blank" href="https://redhat-solution-patterns.github.io/solution-patterns/contributors-guide.html">Contribute</a>

          <div class="navbar-item" >         
              <div id="navbar-form-empty">
                <span >
                  <span>
                    &nbsp;
                    <i style="color: orange;" class="fa fa-exclamation-triangle" aria-hidden="true"></i>
                  </span>
                  Your Workshop Environment
                <form action="javascript:void(0);" onsu>
                  <input size="20" id="managedzone" type="text" placeholder="MANAGED ZONE">
                  <input size="20" id="subdomain" type="text" placeholder="SUBDOMAIN">
                  <button type="hidden" onclick="goWithManagedZone();">Set</button>
                </form>
                </span>
              </div>
        
              <div  id="navbar-form-filled" style="display: none;">
                <span>
                <span>
                  Your Workshop Environment
                    <span class="navbar-text" style="margin-left: 1rem; margin-right: 1rem;">
                    <i alt="Clear details" title="Clear details" onclick="recycle();" style="color: green;" class="fa fa-recycle" aria-hidden="true"></i>
                    <br><span  id="managedZoneDisplay"></span> <span>|</span>
                <span id="subdomainDisplay"></span>
              </div>
          </div>
      </div>
    </div>
  </nav>
</header>

<div class="body">
<div class="nav-container" data-component="solution-pattern" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html" class=" query-params-link">Connectivity Link</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">1. Home page</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html#use-cases">1.1 Use cases</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html#_the_story_behind_this_solution_pattern">1.2 The story behind this solution pattern</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html#_the_solution">1.3 The solution</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-architecture.html">2. Architecture</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-architecture.html#tech_stack">2.1. Technology stack</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-architecture.html#in_depth">2.2. An in-depth look at the solution&#8217;s architecture</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-architecture.html#more_tech">2.3. More about the technology stack</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-demo.html">3. See the Solution in Action</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-demo.html#_prerequisites">3.1. Pre-requisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03.1-platform.html">3.2. Platform Engineer workflow</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="03.2-developer.html">3.3. Developer workflow</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="developer-resources.html">4. Developer Resources</a>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-text"><a href="https://redhat-solution-patterns.github.io/solution-patterns/patterns.html" target="_blank" rel="noopener">Explore Red Hat Solution Patterns</a></span>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Connectivity Link</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Connectivity Link</span>
      <ul class="versions">
        <li class="version is-current">
          <a href="index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Connectivity Link</a></li>
    <li><a href="03-demo.html">3. See the Solution in Action</a></li>
    <li><a href="03.2-developer.html">3.3. Developer workflow</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/redhat-solution-patterns/soln-pattern-connectivity-link/edit/main/documentation/modules/ROOT/pages/03.2-developer.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Solution Pattern: App Connectivity with Policy-as-Code</h1>
<h1 id="_see_the_solution_in_action" class="sect0"><a class="anchor" href="#_see_the_solution_in_action"></a><a class="link" href="#_see_the_solution_in_action">See the Solution in Action</a></h1>
<div class="sect1">
<h2 id="demo-setup"><a class="anchor" href="#demo-setup"></a><a class="link" href="#demo-setup">1. Solution Setup - Onboard ProductCatalog service endpoint</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that the Platform Engineer has made the Gateway available, Developers/App owners can now onboard their application/service endpoints to be available for secure access. Application developers can self service and refine policies to their specific needs in order to protect their exposed service endpoints.</p>
</div>
<div class="paragraph">
<p>In this solution pattern, the Globex developers are now ready to onboard the ProductCatalog service to be securely exposed as an endpoint.</p>
</div>
<div class="sect2">
<h3 id="_run_the_deployment_scripts"><a class="anchor" href="#_run_the_deployment_scripts"></a><a class="link" href="#_run_the_deployment_scripts">1.1. Run the deployment scripts</a></h3>
<div class="ulist">
<ul>
<li>
<p>Run the Ansible script which will setup the <code>ProductCategory Service Endpoint</code> and <code>Globex Mobile app</code>. This also setups Red Hat build of Keycloak for SSO.</p>
<div class="listingblock">
<div class="content">
<pre>cd ../demo-setup
ansible-playbook playbooks/globex.yml \
  -e ACTION=create -e "ocp4_workload_cloud_architecture_workshop_mobile_gateway_url=https://globex-mobile.%MANAGEDZONE%"</pre>
</div>
</div>
</li>
<li>
<p>Expected output:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">PLAY RECAP *****************************************************************************************
localhost   : ok=37   changed=10   unreachable=0    failed=0    skipped=7    rescued=0    ignored=0</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="walkthrough"><a class="anchor" href="#walkthrough"></a><a class="link" href="#walkthrough">2. Solution walkthrough as a Developer</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_test_globex_mobile_app"><a class="anchor" href="#_test_globex_mobile_app"></a><a class="link" href="#_test_globex_mobile_app">2.1. Test Globex Mobile app</a></h3>
<div class="ulist">
<ul>
<li>
<p>Access the Globex Mobile&#8217;s Route from the <strong>globex-apim-user1</strong> namespace &gt; Routes or click  <a href="https://globex-mobile-globex-apim-user1.%SUBDOMAIN%" target="_blank" rel="noopener">here</a></p>
</li>
<li>
<p>Login using <code>asilva/openshift</code> credentials; Click on <code>Categories</code> button on the homespage</p>
</li>
<li>
<p>You should see a 404. This is because the ProductCatalog service-enpoint hasn&#8217;t been exposed using a HTTPRoute</p>
<div class="imageblock">
<div class="content">
<img src="_images/globex-404.png" alt="globex 404">
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_set_up_httproute_for_productcatalog_service_enpoint"><a class="anchor" href="#_set_up_httproute_for_productcatalog_service_enpoint"></a><a class="link" href="#_set_up_httproute_for_productcatalog_service_enpoint">2.2. Set up HTTPRoute for ProductCatalog service-enpoint</a></h3>
<div class="ulist">
<ul>
<li>
<p>Copy the following into the <strong>Import YAML</strong> utility accessible by the (+) button on top of the OpenShift Console</p>
</li>
<li>
<p>In this YAML replace the the <code>spec &gt; hostnames</code> as show below</p>
</li>
</ul>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell script hljs" data-lang="shell script">kind: HTTPRoute
apiVersion: gateway.networking.k8s.io/v1beta1
metadata:
  name: globex-mobile-gateway
  namespace: globex-apim-user1
  labels:
    deployment: globex-mobile-gateway
    service: globex-mobile-gateway
spec:
  parentRefs:
    - kind: Gateway
      namespace: ingress-gateway
      name: prod-web
  hostnames:
    - globex-mobile.%MANAGEDZONE%
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: "/mobile/services/product/category/"
          method: GET
      backendRefs:
        - name: globex-mobile-gateway
          namespace: globex-apim-user1
          port: 8080
    - matches:
        - path:
            type: Exact
            value: "/mobile/services/category/list"
          method: GET
      backendRefs:
        - name: globex-mobile-gateway
          namespace: globex-apim-user1
          port: 8080</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_test_globex_mobile_again_after_httproute_is_setup"><a class="anchor" href="#_test_globex_mobile_again_after_httproute_is_setup"></a><a class="link" href="#_test_globex_mobile_again_after_httproute_is_setup">2.3. Test Globex Mobile again (after HTTPRoute is setup)</a></h3>
<div class="ulist">
<ul>
<li>
<p>Try accessing <strong>Categories</strong> again - you should see a 403.</p>
<div class="imageblock">
<div class="content">
<img src="_images/globex-403.png" alt="globex 403" width="70%">
</div>
</div>
</li>
<li>
<p>This is because while you have the HTTPRoute now, the original deny-all default policy kicks in and doesn&#8217;t allow any requests to made. We have a zero-trust auth in place!!</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_setup_authpolicy"><a class="anchor" href="#_setup_authpolicy"></a><a class="link" href="#_setup_authpolicy">2.4. Setup Authpolicy</a></h3>
<div class="ulist">
<ul>
<li>
<p>Copy the following into the <strong>Import YAML</strong> utility accessible by the (+) button on top of the OpenShift Console</p>
</li>
</ul>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell script hljs" data-lang="shell script">apiVersion: kuadrant.io/v1beta2
kind: AuthPolicy
metadata:
  name: globex-mobile-gateway
  namespace: globex-apim-user1
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: HTTPRoute
    name: globex-mobile-gateway
    namespace: globex-apim-user1
  rules:
    authentication:
      "keycloak-users":
        jwt:
          issuerUrl: https://sso.%SUBDOMAIN%/realms/globex-user1
    response:
      success:
        dynamicMetadata:
          identity:
            json:
              properties:
                userid:
                  selector: auth.identity.sub
  routeSelectors:
    - matches: []</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_test_globex_mobile_again_after_httproute_and_authpolicy_are_setup"><a class="anchor" href="#_test_globex_mobile_again_after_httproute_and_authpolicy_are_setup"></a><a class="link" href="#_test_globex_mobile_again_after_httproute_and_authpolicy_are_setup">2.5. Test Globex Mobile again (after HTTPRoute and AuthPolicy are setup)</a></h3>
<div class="ulist">
<ul>
<li>
<p>Try accessing <strong>Categories</strong> again - you should now be able to see the Categories.</p>
<div class="imageblock">
<div class="content">
<img src="_images/globex-success.png" alt="globex success" width="70%">
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_test_the_default_ratelimit_policy"><a class="anchor" href="#_test_the_default_ratelimit_policy"></a><a class="link" href="#_test_the_default_ratelimit_policy">2.6. Test the default <strong>RateLimit Policy</strong></a></h3>
<div class="ulist">
<ul>
<li>
<p>Try accessing <strong>Categories</strong> again - you should now be able to see the Categories.</p>
</li>
<li>
<p>Click any of the Categories from the list, and then the <strong>Categories</strong> menu, and repeat this a few times.</p>
</li>
<li>
<p>Expect to see a 429 error:</p>
<div class="imageblock">
<div class="content">
<img src="_images/globex-429.png" alt="globex 429" width="70%">
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_create_a_new_ratelimit_policy_which_overrides_default_gateway_policy"><a class="anchor" href="#_create_a_new_ratelimit_policy_which_overrides_default_gateway_policy"></a><a class="link" href="#_create_a_new_ratelimit_policy_which_overrides_default_gateway_policy">2.7. Create a new RateLimit Policy which overrides default gateway policy</a></h3>
<div class="ulist">
<ul>
<li>
<p>Copy the following into the <strong>Import YAML</strong> utility accessible by the (+) button on top of the OpenShift Console</p>
</li>
</ul>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell script hljs" data-lang="shell script">apiVersion: kuadrant.io/v1beta2
kind: RateLimitPolicy
metadata:
  name: globex-mobile-gateway
  namespace: globex-apim-user1
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: HTTPRoute
    name: globex-mobile-gateway
    namespace: globex-apim-user1
  limits:
    "per-user":
      rates:
        - limit: 100
          duration: 10
          unit: second
      counters:
        - metadata.filter_metadata.envoy\.filters\.http\.ext_authz.identity.userid</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_test_globex_mobile_again_after_httproute_authpolicy_and_ratelimitpolicy_are_setup"><a class="anchor" href="#_test_globex_mobile_again_after_httproute_authpolicy_and_ratelimitpolicy_are_setup"></a><a class="link" href="#_test_globex_mobile_again_after_httproute_authpolicy_and_ratelimitpolicy_are_setup">2.8. Test Globex Mobile again (after HTTPRoute, AuthPolicy and RateLimitPolicy are setup)</a></h3>
<div class="ulist">
<ul>
<li>
<p>Try accessing <strong>Categories</strong> again - you should now be able to see the Categories.</p>
</li>
<li>
<p>Click any of the Categories from the list, and then the <strong>Categories</strong> menu, and repeat this a few times.</p>
</li>
<li>
<p>You would now see there is no 429 for up to 100 requests in a duration of 10 seconds.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion"><a class="anchor" href="#_conclusion"></a><a class="link" href="#_conclusion">3. Conclusion</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>With this setup, Globex is all set to onboard further service enpoints to be accessed securely. This solution can be further extended to span across a multi-cluster setup too.</p>
</div>
<div class="paragraph">
<p>We will also extend this pattern to include the all important Observability aspects as well.</p>
</div>
<div class="paragraph">
<p>Read more <a href="https://docs.kuadrant.io/0.8.0/architecture/docs/design/architectural-overview-v1/#multi-cluster" target="_blank" rel="noopener">here</a></p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="03.1-platform.html" class="query-params-link">3.2. Platform Engineer workflow</a></span>
  <span class="next"><a href="developer-resources.html" class="query-params-link">4. Developer Resources</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer" style="justify-content: center;">
  <div>
    <img src="./_images/red_hat_logo.png" height="40px" alt="Cloud Native Architecture Solution Patterns" href="https://redhat.com">
  </div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
